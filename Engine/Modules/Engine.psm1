<#
	.Available languages
	.可用语言

	RegionID = Decimal ID, ISO3166
	Region   = Language/region
	Tag      = Language/region tag
	Name     = Name
	Timezone = Timezone
#>
$Global:Languages_Available = @(
	@{
		RegionID = "1033"
		Region   = "en-US"
		Tag      = "en"
		Name     = "English (United States)"
		Timezone = "Pacific Standard Time"
	}
	@{
		RegionID = "1025"
		Region   = "ar-SA"
		Tag      = "ar"
		Name     = "Arabic (Saudi Arabia)"
		Timezone = "Argentina Standard Time"
	}
	@{
		RegionID = "1026"
		Region   = "bg-BG"
		Tag      = "bg"
		Name     = "Bulgarian (Bulgaria)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "1029"
		Region   = "cs-CZ"
		Tag      = "dz"
		Name     = "Czech (Czech Republic)"
		Timezone = "W. Central Africa Standard Time"
	}
	@{
		RegionID = "1030"
		Region   = "da-DK"
		Tag      = "dk"
		Name     = "Danish (Denmark)"
		Timezone = "Romance Standard Time"
	}
	@{
		RegionID = "1031"
		Region   = "de-DE"
		Tag      = "de"
		Name     = "German (Germany)"
		Timezone = "W. Europe Standard Time"
	}
	@{
		RegionID = "1032"
		Region   = "el-GR"
		Tag      = "gr"
		Name     = "Greek (Greece)"
		Timezone = "GTB Standard Time"
	}
	@{
		RegionID = "2057"
		Region   = "en-gb"
		Tag      = "gb"
		Name     = "English (United Kingdom)"
		Timezone = "GMT Standard Time"
	}
	@{
		RegionID = "3082"
		Region   = "es-ES"
		Tag      = "es-ES"
		Name     = "Spanish (Spain)"
		Timezone = "Romance Standard Time"
	}
	@{
		RegionID = "2058"
		Region   = "es-MX"
		Tag      = "mx"
		Name     = "Spanish (Mexico)"
		Timezone = "Central Standard Time (Mexico)"
	}
	@{
		RegionID = "1061"
		Region   = "et-EE"
		Tag      = "ee"
		Name     = "Estonian (Estonia)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "1035"
		Region   = "fi-FI"
		Tag      = "fi"
		Name     = "Finnish (Finland)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "3084"
		Region   = "fr-CA"
		Tag      = "ca"
		Name     = "French (Canada)"
		Timezone = "Eastern Standard Time"
	}
	@{
		RegionID = "1036"
		Region   = "fr-FR"
		Tag      = "fr"
		Name     = "French (France)"
		Timezone = "Central European Time"
	}
	@{
		RegionID = "1037"
		Region   = "he-IL"
		Tag      = "il"
		Name     = "Hebrew (Israel)"
		Timezone = "Israel Standard Time"
	}
	@{
		RegionID = "1050"
		Region   = "hr-HR"
		Tag      = "hr"
		Name     = "Croatian (Croatia)"
		Timezone = "Central European Standard Time"
	}
	@{
		RegionID = "1038"
		Region   = "hu-HU"
		Tag      = "hu"
		Name     = "Hungarian (Hungary)"
		Timezone = "Central Europe Standard Time"
	}
	@{
		RegionID = "1040"
		Region   = "it-IT"
		Tag      = "it"
		Name     = "Italian (Italy)"
		Timezone = "W. Europe Standard Time"
	}
	@{
		RegionID = "1041"
		Region   = "ja-JP"
		Tag      = "jp"
		Name     = "Japanese (Japan)"
		Timezone = "Tokyo Standard Time"
	}
	@{
		RegionID = "1042"
		Region   = "ko-KR"
		Tag      = "kr"
		Name     = "Korean (Korea)"
		Timezone = "Korea Standard Time"
	}
	@{
		RegionID = "1063"
		Region   = "lt-LT"
		Tag      = "lt"
		Name     = "Lithuanian (Lithuania)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "1062"
		Region   = "lv-LV"
		Tag      = "lv"
		Name     = "Latvian (Latvia)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "1044"
		Region   = "nb-NO"
		Tag      = "no"
		Name     = "Norwegian, Bokmål (Norway)"
		Timezone = "W. Europe Standard Time"
	}
	@{
		RegionID = "1043"
		Region   = "nl-NL"
		Tag      = "nl"
		Name     = "Dutch (Netherlands)"
		Timezone = "W. Europe Standard Time"
	}
	@{
		RegionID = "1045"
		Region   = "pl-PL"
		Tag      = "pl"
		Name     = "Polish (Poland)"
		Timezone = "Central European Standard Time"
	}
	@{
		RegionID = "1046"
		Region   = "pt-BR"
		Tag      = "br"
		Name     = "Portuguese (Brazil)"
		Timezone = "E. South America Standard Time"
	}
	@{
		RegionID = "2070"
		Region   = "pt-PT"
		Tag      = "pt"
		Name     = "Portuguese (Portugal)"
		Timezone = "GMT Standard Time"
	}
	@{
		RegionID = "1048"
		Region   = "ro-RO"
		Tag      = "ro"
		Name     = "Romanian (Romania)"
		Timezone = "GTB Standard Time"
	}
	@{
		RegionID = "1049"
		Region   = "ru-RU"
		Tag      = "ru"
		Name     = "Russian (Russia)"
		Timezone = "Russian Standard Time"
	}
	@{
		RegionID = "1051"
		Region   = "sk-SK"
		Tag      = "sk"
		Name     = "Slovak (Slovakia)"
		Timezone = "Central Europe Standard Time"
	}
	@{
		RegionID = "1060"
		Region   = "sl-SI"
		Tag      = "si"
		Name     = "Slovenian (Slovenia)"
		Timezone = "Central Europe Standard Time"
	}
	@{
		RegionID = "9242"
		Region   = "sr-latn-rs"
		Tag      = "sr-latn-rs"
		Name     = "Serbian (Latin, Serbia)"
		Timezone = "Central Europe Standard Time"
	}
	@{
		RegionID = "1053"
		Region   = "sv-SE"
		Tag      = "se"
		Name     = "Swedish (Sweden)"
		Timezone = "W. Europe Standard Time"
	}
	@{
		RegionID = "1054"
		Region   = "th-TH"
		Tag      = "th"
		Name     = "Thai (Thailand)"
		Timezone = "SE Asia Standard Time"
	}
	@{
		RegionID = "1055"
		Region   = "tr-TR"
		Tag      = "tr"
		Name     = "Turkish (Turkey)"
		Timezone = "Turkey Standard Time"
	}
	@{
		RegionID = "1058"
		Region   = "uk-UA"
		Tag      = "ua"
		Name     = "Ukrainian (Ukraine)"
		Timezone = "FLE Standard Time"
	}
	@{
		RegionID = "2052"
		Region   = "zh-CN"
		Tag      = "cn"
		Name     = "Chinese (Simplified, China)"
		Timezone = "China Standard Time"
	}
	@{
		RegionID = "1028"
		Region   = "zh-TW"
		Tag      = "tw"
		Name     = "Chinese (Traditional, Taiwan)"
		Timezone = "Taipei Standard Time"
	}
)

Function Language_Region
{
	$ResultList = [System.Collections.Generic.List[PSCustomObject]]::new()
	$SeenRegions = [System.Collections.Generic.HashSet[string]]::new()

	function AddUniqueRegion($Item) {
		if ($null -ne $Item.Region -and $SeenRegions.Add($Item.Region)) {
			$ResultList.Add([PSCustomObject]@{
				RegionID = $Item.RegionID
				Region   = $Item.Region
				Tag      = $Item.Tag
				Name     = $Item.Name
				Timezone = $Item.Timezone
			})
		}
	}

	foreach ($item in $Global:Languages_Available) {
		AddUniqueRegion $item

		if ($item.Expand -and $item.Expand.Count -gt 0) {
			foreach ($subItem in $item.Expand) {
				AddUniqueRegion $subItem
			}
		}
	}

	return $ResultList | Sort-Object -Property Region
}

<#
	.Language Module
	.语言模块
#>
Function Language
{
	param
	(
		[string]$NewLang,
		[switch]$Reset,
		[switch]$Auto
	)

	$Global:Author = (Get-Module -Name Engine).Author

	<#
		.Reset
		.重置
	#>
	if ($Reset) {
		$Global:IsLang = $null
	} else {
		if (Get-ItemProperty -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "LanguagePrompt" -ErrorAction SilentlyContinue) {
			$GetLanguagePrompt = Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "LanguagePrompt" -ErrorAction SilentlyContinue
			if ($GetLanguagePrompt -eq "True") {
				if (Get-ItemProperty -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue) {
					$GetLanguage = Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue
					Language_Change -lang $GetLanguage
					Modules_Import -Import
					return
				}
			}
		}
	}

	<#
		.Automatic
		.自动
	#>
	if ($Auto) {
		if (Get-ItemProperty -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue) {
			$GetLanguage = Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue
			Language_Change -lang $GetLanguage
		} else {
			Language_Change -lang (Get-Culture).Name
		}

		Modules_Import -Import
		return
	}

	<#
		.Mandatory use of the specified language
		.强制使用指定语言
	#>
	if (-not ([string]::IsNullOrEmpty($NewLang))) {
		Language_Change -lang $NewLang
		Modules_Import -Import
		return
	}

	<#
		.Saved language
		.已保存语言
	#>
	if ([string]::IsNullOrEmpty($Global:IsLang)) {
		Language_Select_GUI
	} else {
		Language_Change -lang $Global:IsLang
		Modules_Import -Import
	}
}

Function Language_Select_GUI
{
	Add-Type -AssemblyName System.Windows.Forms
	Add-Type -AssemblyName System.Drawing
	[System.Windows.Forms.Application]::EnableVisualStyles()

	Clear-Host
	Write-Host "`n  $($lang.LanguageSelRegion)" -ForegroundColor Yellow
	Write-Host "  $('-' * 80)"

	Function Language_Refresh_Search
	{
		$UI_Main_Menu.controls.Clear()
		$UI_Main_Error.Text = ""
		$UI_Main_Error_Icon.Image = $null

		if (Get-ItemProperty -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue) {
			$GetLanguage = Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "Language" -ErrorAction SilentlyContinue
			$FlagsDefaultLanguage = $GetLanguage
		} else {
			$FlagsDefaultLanguage = (Get-Culture).Name
		}

		$CurrentVersion = (Get-Module -Name Engine).Version

		$Region = Language_Region
		If ([String]::IsNullOrEmpty($UI_Main_Search.Text)) {
			ForEach ($item in $Region) {
				if (Test-Path -Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\$($item.Region)" -PathType Container) {
					$CheckBox   = New-Object System.Windows.Forms.RadioButton -Property @{
						Height  = 35
						Width   = 485
						Text    = $item.Name
						Tag     = $item.Region
					}

					if ($item.Region -eq $FlagsDefaultLanguage) {
						$CheckBox.Checked = $True
					}

					$UI_Main_Menu.controls.AddRange($CheckBox)
				}
			}
		} else {
			$MatchLanguage = @()
			$MatchLanguageResult = @()
			ForEach ($item in $Region) {
				$IsMatch = $True
				if ($IsMatch) {
					if ($item.Name -match $UI_Main_Search.Text) {
						$IsMatch = $False
						$MatchLanguage += $item.Region
					}
				}

				if ($IsMatch) {
					if ($item.Region -match $UI_Main_Search.Text) {
						$IsMatch = $False
						$MatchLanguage += $item.Region
					}
				}

				if ($IsMatch) {
					if ($item.RegionID -match $UI_Main_Search.Text) {
						$IsMatch = $False
						$MatchLanguage += $item.Region
					}
				}
			}

			if ($MatchLanguage.count -gt 0) {
				ForEach ($item in $MatchLanguage) {
					if (Test-Path -Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\$($item)" -PathType Container) {
						$MatchLanguageResult += $item
					}
				}
			}

			$MatchLanguageResult = $MatchLanguageResult | Where-Object { -not ([string]::IsNullOrEmpty($_) -or [string]::IsNullOrWhiteSpace($_))} | Select-Object -Unique
			if ($MatchLanguageResult.count -gt 0) {
				ForEach ($item in $Region) {
					if ($MatchLanguageResult -contains $item.Region) {
						$CheckBox   = New-Object System.Windows.Forms.RadioButton -Property @{
							Height  = 35
							Width   = 485
							Text    = $item.Name
							Tag     = $item.Region
						}

						if ($item.Region -eq $FlagsDefaultLanguage) {
							$CheckBox.Checked = $True
						}

						$UI_Main_Menu.controls.AddRange($CheckBox)
					}
				}
			} else {
				$UI_Main_Other_Rule_Not_Find = New-Object system.Windows.Forms.Label -Property @{
					Height         = 40
					Width          = 485
					Text           = $lang.LanguageSearchNo
				}
				$UI_Main_Menu.controls.AddRange($UI_Main_Other_Rule_Not_Find)
			}
		}
	}

	$UI_Main           = New-Object system.Windows.Forms.Form -Property @{
		autoScaleMode  = 2
		Height         = 720
		Width          = 550
		Text           = $lang.LanguageSelRegion
		StartPosition  = "CenterScreen"
		MaximizeBox    = $False
		MinimizeBox    = $True
		ControlBox     = $True
		BackColor      = "#ffffff"
		FormBorderStyle = "Fixed3D"
		Font           = New-Object System.Drawing.Font($lang.FontsUI, 9, [System.Drawing.FontStyle]::Regular)
	}

	$IconYi = "$($PSScriptRoot)\$((Get-Module -Name Engine).Version.ToString())\Assets\icon\Yi.ico"
	if (Test-Path $IconYi -PathType Leaf) {
		$UI_Main.Icon = [System.Drawing.Icon]::ExtractAssociatedIcon($IconYi)
	}

	$UI_Main_Search    = New-Object System.Windows.Forms.TextBox -Property @{
		Height         = 30
		Width          = 375
		Location       = "20,22"
		Text           = ""
		add_Click      = {
			$This.BackColor = "#FFFFFF"
			$UI_Main_Error_Icon.Image = $null
			$UI_Main_Error.ForeColor = "Black"
		}
	}

	<#
		.搜索或匹配
	#>
	$UI_Main_Search_Refresh = New-Object system.Windows.Forms.Button -Property @{
		UseVisualStyleBackColor = $True
		Location       = "400,15"
		Height         = 36
		Width          = 120
		Text           = $lang.Search
		add_Click      = { Language_Refresh_Search }
	}

	$UI_Main_Menu      = New-Object system.Windows.Forms.FlowLayoutPanel -Property @{
		Height         = 480
		Width          = 528
		Location       = "0,60"
		BorderStyle    = 0
		autoSizeMode   = 1
		autoScroll     = $True
		Padding        = "16,6,0,0"
	}

	$UI_Main_Error_Icon = New-Object system.Windows.Forms.PictureBox -Property @{
		Location       = "10,568"
		Height         = 20
		Width          = 20
		SizeMode       = "StretchImage"
	}
	$UI_Main_Error     = New-Object system.Windows.Forms.Label -Property @{
		Height         = 30
		Width          = 465
		Location       = "35,570"
		Text           = ""
	}
	$UI_Main_Dont_Prompt = New-Object System.Windows.Forms.CheckBox -Property @{
		Height         = 30
		Width          = 508
		Location       = '12,596'
		Text           = $lang.LanguageRemember
		add_Click      = {
			if ($UI_Main_Dont_Prompt.Checked) {
				Save_Dynamic -regkey "Multilingual" -name "LanguagePrompt" -value "True"
			} else {
				Save_Dynamic -regkey "Multilingual" -name "LanguagePrompt" -value "False"
			}
		}
	}
	if (Get-ItemProperty -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "LanguagePrompt" -ErrorAction SilentlyContinue) {
		$GetLanguagePrompt = Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\$($Global:Author)\Multilingual" -Name "LanguagePrompt" -ErrorAction SilentlyContinue
		switch ($GetLanguagePrompt) {
			"True" { $UI_Main_Dont_Prompt.Checked = $True }
			"False" { $UI_Main_Dont_Prompt.Checked = $False }
		}
	}

	$UI_Main_OK        = New-Object system.Windows.Forms.Button -Property @{
		UseVisualStyleBackColor = $True
		Height         = 36
		Width          = 515
		Location       = "8,635"
		Text           = $lang.Ok
		add_Click      = {
			$FlagsLanguageCheck = $False
			$UI_Main_Menu.Controls | ForEach-Object {
				if ($_ -is [System.Windows.Forms.RadioButton]) {
					if ($_.Enabled) {
						if ($_.Checked) {
							Write-host "  $($_.Text)" -ForegroundColor Green

							$FlagsLanguageCheck = $True
							Save_Dynamic -regkey "Multilingual" -name "Language" -value $_.Tag
							Language_Change -lang $_.Tag
							Modules_Import -Import
						}
					}
				}
			}

			if ($FlagsLanguageCheck) {
				$UI_Main.Close()
			} else {
				$UI_Main_Error_Icon.Image = [System.Drawing.Image]::Fromfile("$($PSScriptRoot)\$((Get-Module -Name Engine).Version)\Assets\icon\Error.ico")
				$UI_Main_Error.Text = $lang.LanguageNoSel
			}
		}
	}
	$UI_Main.controls.AddRange((
		$UI_Main_Search,
		$UI_Main_Search_Refresh,
		$UI_Main_Menu,
		$UI_Main_Dont_Prompt,
		$UI_Main_Error_Icon,
		$UI_Main_Error,
		$UI_Main_OK
	))

	Language_Refresh_Search
	$UI_Main.ShowDialog() | Out-Null
}

<#
	.Change language
	.更改语言
#>
Function Language_Change
{
	param
	(
		[string]$lang
	)

	$Global:Lang = @()
	$CurrentVersion = (Get-Module -Name Engine).Version

	if (Test-Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\$($lang)\Lang.psd1" -PathType Leaf) {
		$Global:IsLang = $lang

		Get-ChildItem -Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\$($lang)" -Recurse -include "*.psd1" | ForEach-Object {
			$Global:Lang += Import-LocalizedData -FileName $_.Name -BaseDirectory $_.DirectoryName
		}
	} else {
		if (Test-Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\en-US\Lang.psd1" -PathType Leaf) {
			$Global:IsLang = "en-US"

			Get-ChildItem -Path "$($PSScriptRoot)\$($CurrentVersion)\langpacks\en-US" -Recurse -include "*.psd1" | ForEach-Object {
				$Global:Lang += Import-LocalizedData -FileName $_.Name -BaseDirectory $_.DirectoryName
			}
		} else {
			Clear-Host
			Write-Host "`n  The local language pack is missing or corrupted. Please download it again." -ForegroundColor Red
			Write-Host "  $('-' * 80)"

			Write-host "  Learn more at: " -ForegroundColor Yellow
			write-host "  1. https://fengyi.tel/solutions" -ForegroundColor Green
			write-host "  2. https://github.com/ilikeyi/Multilingual" -ForegroundColor Green
			write-host "`n  Please try again after reinstalling."
			write-host "`n  The application will exit automatically.`n"
			Start-Sleep -s 6
			exit
		}
	}
}

<#
	.Refresh all modules
	.刷新所有模块
#>
Function Modules_Refresh
{
	param
	(
		[string[]]$Functions
	)

	Write-Host
	Write-Host "  " -NoNewline
	Write-Host " $($lang.RefreshModules) " -NoNewline -BackgroundColor White -ForegroundColor Black
	Language -Auto
	Write-Host " $($lang.Done) " -BackgroundColor DarkGreen -ForegroundColor White

	if ($Functions) {
		ForEach ($Function in $Functions) {
			Invoke-Expression -Command $Function
		}
	}
}

<#
	.Import all modules
	.导入所有模块
#>
Function Modules_Import
{
	param
	(
		[switch]$Import
	)

	$CurrentVersion = (Get-Module -Name Engine).Version

	<#
		.Remove all Multilingual modules
		.删除所有 Multilingual 模块
	#>
	Get-Module -Name Engine* | Where-Object -Property Name -like "Engine*" | ForEach-Object {
		Remove-Module -Name $_.Name -Force -ErrorAction Ignore
	}

	if ($Import) {
		Import-Module -Name $PSScriptRoot\..\Modules\Engine.psd1 -Scope Global -Force | Out-Null

		<#
			.Import all *.psd1
			.导入所有 *.psd1
		#>
		Get-ChildItem -Path "$($PSScriptRoot)\$($CurrentVersion)\Functions" -Recurse -include "Engine.*.psd1" | ForEach-Object {
			Import-Module -Name $_.FullName -Scope Global -Force
		}
	}
}